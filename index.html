<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEMCA - Monitoreo de Calidad de Aire</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    /* MANTENGO TUS ESTILOS ORIGINALES */
    header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5%; background-color: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .logo-img { height: 60px; width: 200px; background-size: contain; background-repeat: no-repeat; background-position: center; }
    .logo-ministerio { background-image: url('https://i.ibb.co/v4m86mN/logo-ministerio.png'); }
    .logo-cemca { background-image: url('https://i.ibb.co/vYmYmYm/logo-cemca.png'); }
    #map { height: 600px; width: 100%; margin-top: 20px; z-index: 1; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; font-family: sans-serif; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* ... (puedes pegar aquí el resto de tus estilos del archivo original) ... */
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p>Cargando Mapa de Estaciones...</p>
</div>

<header>
  <div class="logo-img logo-ministerio"></div>
  <div class="logo-img logo-cemca"></div>
</header>

<div id="map"></div>

<div id="modalEstacion" class="modal">...</div> 

<script>
  // URL DE TU API EN GOOGLE SCRIPTS
  const urlScript = "https://script.google.com/macros/s/AKfycbwQuKxZtFy1Hz-cp-x9VCgNKhnu-S8q_EKUBeJpcW3FuZwhk5vkDkdRkCyxlxdpRFi4/exec";

  let map;
  let estacionesGlobal = [];

  // 1. FUNCIÓN PRINCIPAL DE CARGA (FETCH)
  async function cargarApp() {
    try {
      const response = await fetch(`${urlScript}?action=obtenerEstaciones`);
      const data = await response.json();
      
      estacionesGlobal = data;
      inicializarMapa();
      renderizarMarcadores(data);
      
      // Ocultar loading
      document.getElementById('loading').style.display = 'none';
    } catch (error) {
      console.error("Error cargando estaciones:", error);
      document.querySelector('#loading p').innerText = "Error al conectar con la base de datos.";
    }
  }

  function inicializarMapa() {
    map = L.map('map').setView([-34.6, -58.6], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  }

  function renderizarMarcadores(estaciones) {
    estaciones.forEach(est => {
      const marker = L.marker([est.lat, est.lng]).addTo(map);
      marker.bindPopup(`<b>${est.nombre}</b><br>Calidad: ${est.calidad}<br><button onclick="abrirDetalles('${est.nombre}')">Ver Detalles</button>`);
    });
  }

  // 2. ADAPTACIÓN DE TUS OTRAS FUNCIONES (Ejemplo Historico)
  async function abrirDetalles(nombre) {
    // En lugar de google.script.run, usamos fetch
    const res = await fetch(`${urlScript}?action=obtenerHistorico&estacion=${encodeURIComponent(nombre)}`);
    const data = await res.json();
    
    // Aquí llamarías a tu función mostrarGrafico(data) que ya tienes
    console.log("Datos recibidos para:", nombre, data);
  }

  // INICIAR TODO
  window.onload = cargarApp;

</script>
</body>
</html>
