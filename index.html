<!DOCTYPE html>
<html>
<head>
 <link rel="icon" type="image/jpeg" href="https://lh3.googleusercontent.com/d/1E9BU-seji6PRCrmVUC368s8rJrkqY7-q">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEMCA - Monitoreo de Calidad de Aire</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 90px;            /* Subimos un poco el header */
    background-color: #ffffff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    width: 100%;
    padding: 0;
    overflow: hidden;   
    background-color: #ffffff;  
    border-bottom: 3px solid #00b1c9; 
    justify-content: space-between; 
    z-index: 1001;/* Evita que si el logo es muy grande rompa el diseño */
}

/* Contenedor Izquierdo (Sobre la Sidebar) */
.header-izq {
    width: 300px;             /* Ajusta al ancho de tu sidebar */
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Contenedor Derecho (Ministerio) */
.header-der {
    flex-grow: 1;
    height: 100%;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding-right: 50px;      /* Menos padding para que el logo gane espacio */
}

/* LOGO CEMCA: Ajuste para que se vea GRANDE */
.logo-cemca {
    width: 100%;               /* Que use casi todo el ancho de los 300px */
    height: 90px;            /* Casi la altura total del header (120px) */
    background-image: url("https://lh3.googleusercontent.com/d/1E9BU-seji6PRCrmVUC368s8rJrkqY7-q");
    background-size: contain; /* Forzamos el ancho al 100% */
    background-repeat: no-repeat;
    background-position: center;
}

/* LOGO MINISTERIO: Ajuste para máxima legibilidad */
.logo-ministerio {
    width: 500px;             /* Aumentamos mucho el ancho permitido */
    height: 90px;            /* Casi el alto total del header */
    background-image: url("https://lh3.googleusercontent.com/d/1d7U3yQ6OGAORYFk762nozJW8_YbsMYRE");
    background-size: contain; 
    background-repeat: no-repeat;
    background-position: right center;
}
   .header-buttons-mobile {
    display: none;
}

/* Ajuste para que el mapa no se pegue */
#map-container {height: calc(100vh - 110px);}
body, html { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; overflow: hidden; }

    .main-wrapper { display: flex; flex: 1; position: relative; overflow: hidden; }

    #meteo-area {display: flex; flex-direction: column; gap: 20px; }
   .btn-detalle-mobile {
    display: none !important;
}

    .station-menu {
  display: flex;
  justify-content: space-around;
  background: #f1f3f4;
  padding: 8px;
  border-radius: 10px;
  margin: 10px 0;
}

.menu-item {
  cursor: pointer;
  padding: 10px;
  color: #7f8c8d;
  border-radius: 8px;
  transition: 0.3s;
}

.menu-item:hover {
  background: #e0e0e0;
  color: #2c3e50;
}

.menu-item.active {
  background: #ffffff;
  color: #3498db;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Contenedor externo para el margen */
.search-wrapper {
    padding: 15px;
    background: #ffffff;
    border-bottom: 1px solid #eee;
}

/* El cuadro del buscador */
.search-container {
    display: flex;
    align-items: center;
    background: #f1f3f4; /* Gris muy suave de fondo */
    border-radius: 12px;
    padding: 8px 15px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

/* Efecto cuando el usuario hace clic para escribir */
.search-container:focus-within {
    background: #ffffff;
    border-color: #00acc1; /* Borde celeste al activar */
    box-shadow: 0 0 8px rgba(0, 172, 193, 0.2);
}

/* Tamaño y color del icono celeste */
.search-icon {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    display: flex;
    align-items: center;
}

.search-icon svg {
    width: 100%;
    height: 100%;
}

/* El input real (sin bordes) */
#search-input {
    width: 100%;
    border: none;
    background: transparent;
    outline: none;
    font-size: 15px;
    color: #444;
}

/* Color del texto de ayuda */
#search-input::placeholder {
    color: #999;
}
.btn-filtro-contam {
  background: white;
  border: 1px solid #dfe6e9;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 5px;
  font-size: 12px;
  transition: all 0.2s;
}
.btn-filtro-contam.active {
  background: #0984e3;
  color: white;
  border-color: #0984e3;
}
.report-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.report-table th, .report-table td {
  border: 1px solid #eee;
  padding: 8px;
  text-align: center;
}
.report-table th { background: #f8f9fa; }
.tab-pane {
  padding-top: 10px;
}

chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 5px;
    border-bottom: 1px solid #eee;
}
   

   
.status-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
}

.status-danger {
    background-color: #ffeaea;
    color: #d63031;
    border: 1px solid #fab1a0;
}

.status-success {
    background-color: #e3f9e5;
    color: #27ae60;
    border: 1px solid #b7ebbe;
}

.status-info {
    background-color: #f1f2f6;
    color: #636e72;
    border: 1px solid #dfe6e9;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

    /* Cargadores */
    #main-loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    #charts-loader { display: none; text-align: center; padding: 40px 0; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #00b1c9; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Sidebar */
    #sidebar { width: 320px; height: 100%; overflow-y: auto; background: #f4f7f6; border-right: 1px solid #ddd; }
    .partido-title { background: #00b1c9; color: white; padding: 10px 15px; font-size: 0.85em; font-weight: bold; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
    .station-card { padding: 12px; margin: 5px 10px; background: white; border-radius: 4px; cursor: pointer; border-left: 5px solid #ccc; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .ica-badge { padding: 3px 10px; border-radius: 12px; font-weight: bold; font-size: 0.8em; }

    #map { flex: 1; height: 100%; z-index: 1; }

    /* Panel Derecho */
    /* Panel Derecho */
    #details-panel { width: 0; height: 100%; background: white; border-left: 1px solid #ddd; overflow-y: auto; transition: width 0.3s ease; position: relative; z-index: 1002; }
    #details-panel.active { width: 460px; }
    .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999; z-index: 10; }
    .details-content { padding: 25px; }
   .btn-volver-panel {
    display: none !important;
}
   .btn-mobile-only { display: none; }
  

    .gauge-wrapper { margin-top: 0px; position: relative; width: 260px; margin: 0 auto 20px auto; }
    .gauge-value-center { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); text-align: center; }
    .gauge-value-center span { display: block; font-size: 2.8em; font-weight: bold; line-height: 1; }
    .gauge-limits { display: flex; justify-content: space-between; width: 100%; font-size: 0.8em; color: #aaa; margin-top: 0px; padding: 0 15px; }

    .recommendation-card { padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 0.9em; border-left: 6px solid #ccc; background: #f9f9f9; }
    .chart-box { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .chart-container { height: 160px; margin-top: 10px; }
    footer { background: #2d3436; color: white; text-align: center; padding: 5px; font-size: 0.8em; margin: 0}
     footer p {
    margin: 0 !important; 
    padding: 2px 2; /* Controlas el espacio exacto entre renglones aquí */
    line-height: 1.2;
}

    /* Estilos para el Pop-up del mapa */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 3px 14px rgba(0,0,0,0.2);
    }
    .leaflet-popup-tip {
      background: white;
    }

/* Contenedor principal */
.ayuda-wrapper {
  position: fixed;
  bottom: 25px;
  right: 25px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Columna de botones */
.fab-btn-simple {
  position: fixed;
  right: 25px; /* Posición inicial */
  width: 65px;
  height: 65px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  text-decoration: none;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 1000;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: none;
}

/* Colores institucionales */
#btn-ministerio { background-color: #00aec3; } /* Gris oscuro */
#btn-email { background-color: #00aec3; }      /* Azul */
#btn-ayuda { background-color: #00aec3; }      /* Turquesa */

.fab-btn-simple:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 15px rgba(0,0,0,0.3);
}

/* Ajuste del Pop-up para que no tape los botones nuevos */
.faq-hover-card {
  position: absolute;
  bottom: 170px; /* Subimos el popup para que aparezca sobre la columna */
  right: 0;
  width: 230px;
  /* ... resto de los estilos del popup se mantienen igual ... */
}
/* Estilos básicos para el Modal de Preguntas */
.faq-modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0; top: 0; width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.faq-content {
  background-color: white;
  margin: 5% auto;
  padding: 20px;
  width: 70%;
  max-height: 80vh;
  overflow-y: auto;
  border-radius: 10px;
  position: relative;
}

.close-faq { float: right; font-size: 28px; cursor: pointer; }

/* Contenedor de cada ítem del acordeón */
.accordion-item {
  border-bottom: 1px solid #eee;
  width: 100%;
}

/* Encabezado (La Pregunta) */
.accordion-header {
  background-color: #f8f9fa;
  color: #333;
  cursor: pointer;
  padding: 15px;
  width: 100%;
  text-align: left;
  border: none;
  outline: none;
  transition: 0.4s;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.accordion-header:hover { background-color: #e9ecef; }

/* Icono de flecha */
.accordion-header::after {
  content: '\25bc'; /* Flecha hacia abajo */
  font-size: 12px;
  color: #00b1c9;
  transition: transform 0.3s ease;
}

.accordion-header.active::after {
  transform: rotate(180deg); /* Gira la flecha al abrir */
}

/* Panel de respuesta (Escondido por defecto) */
.accordion-panel {
  padding: 0 15px;
  background-color: white;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}

.accordion-panel p {
  padding: 15px 0;
  margin: 0;
  line-height: 1.6;
  color: #555;
}

#tab-info img {
    max-height: 180px;
    object-fit: cover;
}

.btn-web:hover {
    background: #008fa1;
    transition: 0.3s;
}

#tab-info {
    max-height: 80vh; /* Para que tenga scroll si el texto es largo */
    overflow-y: auto;
}

/* Fondo oscuro detrás del modal */
.modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none; /* Se activa con JS */
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

/* Caja del formulario */
.modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #00aec3;
    padding-bottom: 10px;
}

.input-group { margin-bottom: 15px; }
.input-group label { display: block; font-weight: 600; margin-bottom: 5px; }
.input-group input, .input-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: inherit;
}

.btn-enviar {
    width: 100%;
    padding: 12px;
    background: #0077b6;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-enviar:hover { background: #023e8a; }

.close-modal { font-size: 28px; cursor: pointer; color: #666; }

.toast-notificacion {
    position: fixed;
    top: -200px; /* Empieza fuera de la pantalla */
    left: 50%;
    transform: translateX(-50%);
    background-color: #2d3436; /* Gris institucional */
    color: white;
    padding: 15px 25px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 3000;
    transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    align-items: center;
    border-left: 5px solid #00aec3; /* Turquesa CEMCA */
}

.toast-contenido {
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: 'Segoe UI', sans-serif;
    font-weight: 500;
}

.toast-contenido i {
    color: #00aec3;
    font-size: 1.2em;
}

/* Clase para mostrarlo */
.toast-notificacion.mostrar {
    top: 30px; /* Se desplaza hacia abajo */
}

   .meteo-grid {
    display: grid;
    /* Crea columnas de mínimo 120px que se ajustan solas al ancho disponible */
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

/* Estilo de cada Tarjeta */
.meteo-card {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 15px 10px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Efecto hover sutil */
.meteo-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    border-color: #00aec3;
}

/* Iconos */
.meteo-card i {
    font-size: 1.6rem;
    color: #00aec3;
    margin-bottom: 8px;
    display: block;
}

/* Título del dato (ej: TEMPERATURA) */
.meteo-card span {
    display: block;
    font-size: 0.7rem;
    color: #636e72;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 700;
    margin-bottom: 4px;
}

/* Valor numérico (ej: 25.4°C) */
.meteo-card strong {
    display: block;
    font-size: 1.2rem;
    color: #2d3436;
    font-weight: 800;
    line-height: 1.1;
    margin-top: 5px;
    word-wrap: break-word;
}

   .meteo-card small {
    margin-top: 2px;
    font-weight: normal;
}

/* Clase especial para la flecha del viento */
.wind-arrow {
    display: inline-block;
    transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    color: #00aec3 !important; /* Color rojizo para destacar el viento */
}


 @media (max-width: 768px) {
  header {
        display: flex !important;
        justify-content: space-between !important; /* CEMCA izquierda, Botones derecha */
        align-items: center !important;
        padding: 0 px !important;
        height: 80px !important;
    }

    .header-izq {
        width: auto !important;
        display: flex !important;
        justify-content: flex-start !important;
    }

    /* Ocultamos el logo del ministerio original */
    .header-der {
        display: none !important;
    }

    .logo-cemca {
        width: 130px; /* Ajustado para dar espacio a los botones */
        height: 79px;
        background-size: contain;
        background-repeat: no-repeat;
    }

    .btn-detalle-mobile {
        display: block !important; /* Forzamos la aparición solo en móvil */
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        background-color: #00acc1;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold
    }

  .meteo-grid {
        grid-template-columns: repeat(2, 1fr); /* En celular muy chico, 2 columnas fijas */
    }
    .meteo-card strong {
        font-size: 1rem;
    }

    /* Contenedor de iconos */
    .header-buttons-mobile {
        display: flex !important;
        gap: 20px; /* Más espacio entre los botones */
        align-items: center;
        margin-right: 20px;
    }

    /* Estilo de los iconos en Celeste Institucional */
    .header-btn-icon {
        color: #00acc1 !important; /* Celeste institucional */
        font-size: 1.5rem; /* Tamaño cómodo para el dedo */
        fill: #00acc1 !important;  /* Por si el navegador lo interpreta como SVG */
        font-size: 1.5rem;
        cursor: pointer;
    }
 
  /* Ocultar botones flotantes originales */
    #btn-ministerio, #btn-email, #btn-ayuda {
        display: none !important;
    }

    /* Contenedor para los nuevos botones en el header */
 .main-wrapper {
    position: relative; /* Esto es vital */
    display: flex;
    flex: 1;
    overflow: hidden;
}

  
    .main-container {
        position: relative;
        height: calc(100vh - 120px); /* Ajusta según el alto de tu header */
        overflow: hidden;
    }

    #sidebar {
        width: 100% !important;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        background: white;
        transition: transform 0.3s ease;
    }

    #map {
        width: 100% !important;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }
  
  .btn-mobile-only {
        display: block;
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        background-color: #00acc1;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
    }

    /* Clase para "minimizar" la sidebar y mostrar el mapa */
    #sidebar.hidden-mobile {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
    }
  
#details-panel {
        display: none; 
        width: 100% !important;
        
        /* CAMBIO CLAVE: position absolute respecto al contenedor padre */
        position: absolute !important; 
        left: 0 !important;
        top: 0 !important;
        bottom: 0 !important; /* Se estira hasta donde empieza el footer */
        
        height: auto !important; /* Ya no depende de calc(100vh) */
        background: white !important;
        z-index: 3000 !important; /* Suficiente para estar sobre el mapa */
        
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
        flex-direction: column;
    }

    #details-panel.active-mobile {
        display: flex !important;
    }


#btn-volver-lista-flotante {
    position: fixed;         /* Se queda fijo en la pantalla */
    bottom: 100px;            /* Distancia desde el borde inferior */
    left: 50%;               /* Lo mueve al centro horizontal */
    transform: translateX(-50%); /* Ajuste perfecto para centrarlo */
    
    z-index: 2900;           /* Valor alto para estar sobre el mapa y botones de Leaflet */
    
    background-color: #2d3436; /* Color oscuro institucional (contrasta bien con el mapa) */
    color: white;
    padding: 12px 25px;
    border-radius: 30px;     /* Forma de "píldora" moderna */
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4); /* Sombra para dar profundidad */
    
    font-family: 'Segoe UI', sans-serif;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    
    display: flex;           /* Alinea el icono y el texto */
    align-items: center;
    gap: 10px;               /* Espacio entre el icono de lista y el texto */
    
    white-space: nowrap;     /* Evita que el texto se parta en dos renglones */
    transition: all 0.3s ease;
}

/* Efecto al presionar (opcional) */
#btn-volver-lista-flotante:active {
    transform: translateX(-50%) scale(0.95);
    background-color: #000;
}
   
  footer {
        flex-direction: column !important; /* Apila los elementos */
        height: auto !important;           /* Permite que crezca según el texto */
        padding: 10px 5px !important;
        text-align: center;
        gap: 8px;                          /* Espacio entre los dos renglones */
    }

    footer p {
        margin: 0;
        font-size: 13px;                   /* Ajuste de tamaño para móviles */
        line-height: 1.1;
     z-index: 10050 !important;
    }

}


    
  </style>
</head>
<body>

<header>
    <div class="header-izq">
        <div class="logo-cemca"></div>
    </div>
 <div class="header-buttons-mobile">
        <i class="fas fa-envelope header-btn-icon" onclick="abrirContacto()" title="Mensaje"></i>
        <i class="fas fa-question-circle header-btn-icon" onclick="abrirModalPreguntas()" title="Ayuda"></i>
        <i class="fas fa-arrow-left header-btn-icon" onclick="window.open('https://www.ambiente.gba.gob.ar/', '_blank')" title="Ministerio"></i>
    </div>
    <div class="header-der">
        <div class="logo-ministerio"></div>
    </div>
</header>
 
  <div class="main-wrapper">
 <div id="main-loader" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: white;
    display: flex;
    flex-direction: column; /* Coloca la imagen sobre el loader */
    align-items: center;
    justify-content: center;
    z-index: 9999;">

    <img src="https://lh3.googleusercontent.com/d/1E9BU-seji6PRCrmVUC368s8rJrkqY7-q" 
     alt="Logo" 
     style="
        width: 250px;           /* Aumenta este número para hacerla más grande */
        height: auto;           /* Mantiene la proporción original */
        margin-bottom: 25px;    /* Espacio entre imagen y spinner */
        border-radius: 0%;      /* 0% para que sea cuadrada/original */
        object-fit: contain;    /* Asegura que la imagen no se deforme */
     ">

    <div class="spinner"></div>
    
    <p style="margin-top: 15px; color: #666; font-family: sans-serif;">Cargando estaciones...</p>
</div>
    <div id="sidebar"><div class="search-wrapper">
    <div class="search-container">
        <div class="search-icon">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.7955 15.8111L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" 
                stroke="#00acc1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <input type="text" id="search-input" placeholder="Buscar partido...">
    </div>
      <button id="btn-ver-mapa-mobile" class="btn-detalle-mobile" onclick="toggleVistaMapa()">
        <i class="fas fa-map-marked-alt"></i> Buscar en el mapa
    </button>
</div><div id="station-list"></div>
<div id="station-list">
  </div></div>
    <div id="map"></div>
   
<div id="details-panel">
  <span class="close-btn" onclick="cerrarPanel()">&times;</span>
  
  <div class="details-content">
    <h2 id="det-nombre" style="text-align:center; margin-bottom: 15px;">Estación</h2>

    <div class="station-menu">
      <div class="menu-item active" onclick="switchTab(event, 'tab-ica')" title="Calidad del Aire">
        <i class="fas fa-wind"></i>
      </div>
      <div class="menu-item" onclick="switchTab(event, 'tab-meteo')" title="Meteorología">
        <i class="fas fa-cloud-sun"></i>
      </div>
      <div class="menu-item" onclick="switchTab(event, 'tab-info')" title="Información Estación">
        <i class="fas fa-info-circle"></i>
      </div>
      <div class="menu-item" onclick="switchTab(event, 'tab-diario')" title="Datos Diarios">
        <i class="fas fa-calendar-day"></i>
      </div>
      <div class="menu-item" onclick="switchTab(event, 'tab-mensual')" title="Datos Mensuales">
        <i class="fas fa-calendar-alt"></i>
      </div>
      <div class="menu-item" onclick="switchTab(event, 'tab-anual')" title="Datos Anuales">
        <i class="fas fa-chart-line"></i>
      </div>
    </div>
 

    <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

    <div id="dynamic-content">
      
      <div id="tab-ica" class="tab-pane active">
        <div class="gauge-wrapper" style="text-align: center;">
          <canvas id="gaugeChart"></canvas>
          <div id="gauge-label-container" style="margin-top: 10px;">
            <span id="gauge-number" style="font-size: 3.2em; font-weight: 800; display: block;">--</span>
          </div>
        </div>
        <div id="rec-card" class="recommendation-card">
          <strong id="rec-cat-text">Categoría</strong>
          <p id="rec-desc-text"></p>
        </div>
        <div id="charts-loader" style="display:active;"><div class="spinner"></div></div>
        <div id="historico-section">
          <h2 style="margin: 0; color: #2d3436;text-align: center;">Concentraciones recientes</h2>
          <div id="last-update-tag" style="font-size: 0.85em; color: #636e72; margin-bottom: 15px;text-align: center;">
            <i class="far fa-clock"></i> Última actualización: <span id="update-time"></span>
          <div id="charts-area"></div>
          </div>
      
        </div>
      </div>

     <div id="tab-meteo" class="tab-pane" style="display:none;">
    <h3 style="text-align:center;">Datos Meteorológicos</h3>
    <div id="meteo-cards-container"></div>
    <div id="meteo-charts-section"></div>
    <div id="rosa-contenedor" style="width: 100%; height: 400px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; display:none;"></div>
</div>

      <div id="tab-info" class="tab-pane" style="display:none;">
        <h3 style="text-align:center;">Datos de la Estación</h3>
      </div>

      <div id="tab-diario" class="tab-pane" style="display:none;">
  <div style="background: #f1f2f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
      <label for="select-periodo" style="font-weight: bold; color: #2d3436;">Seleccionar Periodo:</label>
      <select id="select-periodo" onchange="cargarPestanaPromedio()" style="padding: 8px; border-radius: 5px; border: 1px solid #dfe6e9; min-width: 180px;">
        </select>
    </div>
  </div>

  <div id="promedio-loader" style="display:none; text-align: center; padding: 40px;">
    <div class="spinner"></div>
    <p style="color: #636e72; margin-top: 10px;">Calculando promedios diarios...</p>
  </div>

  <div id="promedio-charts-area">
    </div>
</div>
  
  
  <div id="tab-mensual" class="tab-pane" style="display:none;">
  <div style="padding: 15px;">
    
    <div id="mensual-loader" style="display:none; text-align: center; padding: 40px;">
      <div class="spinner"></div>
      <p style="font-size: 13px; color: #666; margin-top: 10px;">Cargando informes...</p>
    </div>

    <div id="mensual-filtros" style="display:none;">
      <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
        <label style="font-weight: bold; font-size: 13px;">Filtrar por Año:</label>
        <select id="select-año-mensual" onchange="actualizarVistaPorFiltros()" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;"></select>
      </div>

      <div class="selector-container">
        <h4 style="margin-bottom: 10px; color: #2d3436;">Seleccionar Contaminante:</h4>
        <div id="contaminantes-list" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;"></div>
      </div>
    </div>

    <div id="mensual-content" style="display:none;">
      <div class="chart-box" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; height: 300px; border: 1px solid #eee;">
        <canvas id="canvas-mensual"></canvas>
      </div>
      <div id="tabla-mensual-area"></div>
    </div>

  </div>
</div>
      
      <div id="tab-anual" class="tab-pane" style="display:none;"></div>
<button class="btn-volver-panel" onclick="cerrarPanel()">
        <i class="fas fa-arrow-left"></i> Volver a Estaciones</button>
    </div>
     
    
  </div>
</div>
 </div>

<a href="https://www.ambiente.gba.gob.ar/" target="_blank" id="btn-ministerio" class="fab-btn-simple" title="Volver al Ministerio de Ambiente" style="bottom: 60px;">
  <i class="fas fa-university" style="font-size: 1.6em;"></i>
</a>

<a href="mailto:cemca@ambiente.gba.gob.ar" id="btn-email" onclick="abrirContacto()"  class="fab-btn-simple" title="Contactar al CEMCA" style="bottom: 130px;">
  <i class="fas fa-envelope" style="font-size: 1.6em;"></i>
</a>

<div id="btn-ayuda" class="fab-btn-simple" onclick="abrirModalPreguntas()" title="Preguntas Frecuentes" style="bottom: 200px;">
  <i class="fas fa-question" style="font-size: 1.6em;"></i>
</div>
 
</div>
<div id="modal-faq" class="faq-modal">
  <div class="faq-content">
    <span class="close-faq" onclick="cerrarModalPreguntas()">&times;</span>
    <h3>Preguntas Frecuentes</h3>
    <div id="faq-lista"></div> </div>
</div>
 
 <div id="modal-contacto" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-envelope"></i> Contactar al CEMCA</h3>
            <span class="close-modal" onclick="cerrarContacto()">&times;</span>
        </div>
        <form id="form-cemca">
            <div class="input-group">
                <label>Nombre y Apellido</label>
                <input type="text" placeholder="Tu nombre..." required>
            </div>
            <div class="input-group">
                <label>Correo Electrónico</label>
                <input type="email" placeholder="ejemplo@correo.com" required>
            </div>
            <div class="input-group">
                <label>Asunto</label>
                <input type="text" id="asunto-mail" value="Consulta sobre Calidad del Aire">
            </div>
            <div class="input-group">
                <label>Mensaje</label>
                <textarea rows="4" placeholder="Escribe tu consulta aquí..."></textarea>
            </div>
            <button type="submit" class="btn-enviar">Enviar Mensaje</button>
        </form>
    </div>
</div>

 <div id="notificacion-exito" class="toast-notificacion">
    <div class="toast-contenido">
        <i class="fas fa-check-circle"></i>
        <span>¡Gracias! Tu consulta ha sido enviada al equipo del CEMCA.</span>
    </div>
</div>

    <footer>
    <p><strong>CEMCA</strong></p>
    <p>Ministerio de Ambiente de la Provincia de Buenos Aires</p>
</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
const urlScript = "https://script.google.com/macros/s/AKfycbw-5bsM4H5VRY1D_eeBYyBENaENQJAKzT_N73hmFmRqC8--vggGCw5BfwBRT71MTfW8/exec";
var map = L.map('map').setView([-36.60, -60.10], 6); // Coordenadas de la provincia

// 2. Definimos el proveedor principal (OSM)
var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
});

// 3. Definimos el proveedor de respaldo (Esri)
var esriLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri'
});

// 4. Intentamos cargar el principal
osmLayer.addTo(map);

// 5. Lógica de detección de error
// Si una imagen del mapa (tile) falla al cargar, esperamos un momento y cambiamos la capa
osmLayer.on('tileerror', function(error) {
    console.warn("Falla en OSM, cambiando a servidor de respaldo Esri...");
    map.removeLayer(osmLayer);
    esriLayer.addTo(map);
});
let marcadoresEstaciones = {}; // <--- AGREGAR ESTO para guardar los marcadores
let estacionesGlobal = [];
let gaugeChart = null;
let barCharts = [];
let meteoCharts = [];
let promedioCharts = [];
let chartMensualInstance = null; // Para destruir el gráfico anterior

    // Colores estándar por nivel de riesgo
    const COLORS = { GREEN: "#2ecc71", YELLOW: "#f1c40f", ORANGE: "#e67e22", RED: "#e74c3c", PURPLE: "#9b59b6", MAROON: "#8e44ad", GRAY: "#b2bec3", MAROON: "#7e0023" };

    // 1. Lógica de Colores por Concentración (ug/m3) según límites de cálculo ICA
    function getColorByConcentracion(valor, tipo) {
      let v = parseFloat(valor);
      if (isNaN(v) || v < 0) return COLORS.GRAY;

      switch(tipo) {
        case "PM2.5":
          if (v <= 12.0) return COLORS.GREEN;
          if (v <= 35.4) return COLORS.YELLOW;
          if (v <= 55.4) return COLORS.ORANGE;
          if (v <= 150.4) return COLORS.RED;
          if (v <= 250.4) return COLORS.PURPLE;
          return COLORS.MAROON;
        case "PM10":
          if (v <= 54) return COLORS.GREEN;
          if (v <= 154) return COLORS.YELLOW;
          if (v <= 254) return COLORS.ORANGE;
          if (v <= 354) return COLORS.RED;
          if (v <= 424) return COLORS.PURPLE;
          return COLORS.MAROON;
        case "NO2":
          if (v <= 53) return COLORS.GREEN;
          if (v <= 100) return COLORS.YELLOW;
          if (v <= 360) return COLORS.ORANGE;
          return COLORS.RED;
        case "SO2":
          if (v <= 35) return COLORS.GREEN;
          if (v <= 75) return COLORS.YELLOW;
          if (v <= 185) return COLORS.ORANGE;
          return COLORS.RED;
        case "O3":
          if (v <= 54) return COLORS.GREEN;
          if (v <= 70) return COLORS.YELLOW;
          if (v <= 85) return COLORS.ORANGE;
          if (v <= 105) return COLORS.RED;
          return COLORS.PURPLE;
        case "CO":
          if (v <= 4400) return COLORS.GREEN;
          if (v <= 9400) return COLORS.YELLOW;
          if (v <= 12400) return COLORS.ORANGE;
          if (v <= 15400) return COLORS.RED;
          return COLORS.PURPLE;
        default:
          return COLORS.GRAY;
      }
    }
  
    function getICAInfo(v) {
      let valor = parseFloat(v);
      if (isNaN(valor)) return { label: "Sin Datos", color: COLORS.GRAY, rec: "No disponible." };
      if (valor <= 50) return { label: "Bueno", color: COLORS.GREEN, rec: "Se pueden realizar actividades al aire libre con normalidad" };
      if (valor <= 100) return { label: "Moderado", color: COLORS.YELLOW, rec: "Se recomienda a las personas sensibles reducir el esfuerzo al aire libre." };
      if (valor <= 150) return { label: "Insalubre Para Grupos Sensibles", color: COLORS.ORANGE, rec: "Ancianos, niños y personas con dificultades respiratorias deben evitar realizar actividades al aire libre" };
      if (valor <= 200) return { label: "Insalubre", color: COLORS.RED, rec: "Toda la población debe evitar realizar actividades al aire libre" };
      if (valor <= 300) return { label: "Muy Insalubre", color: COLORS.PURPLE, rec: "se recomienda permanecer en el interior" };
      return { label: "Peligroso", color: COLORS.MAROON, rec: "Permanezca en interiores." };
    }

async function cargarEstacionesIniciales() {
  try {
    // Llamamos a la API de Google con el parámetro action=obtenerEstaciones
    const response = await fetch(`${urlScript}?action=obtenerEstaciones`);
    const estaciones = await response.json();

   // 2. GUARDAR LOS DATOS EN LA VARIABLE GLOBAL
    window.estacionesGlobal = estaciones;

    // --- AQUÍ EMPIEZA TU LÓGICA ORIGINAL ---
    const listDiv = document.getElementById('station-list');
    const grupos = {};
    
    // Ordenamos las estaciones por calidad
    estaciones.sort((a, b) => (parseFloat(a.calidad) || 0) - (parseFloat(b.calidad) || 0));

    estaciones.forEach(est => {
      const info = getICAInfo(est.calidad);
      const tieneIca = !isNaN(parseFloat(est.calidad));


  const radioDinamic = tieneIca ? 11 : 5;

  const marcador = L.circleMarker([est.lat, est.lng], { 
    radius: radioDinamic, 
    fillColor: tieneIca ? info.color : "#bdc3c7", // Gris si no tiene datos para diferenciarlo más
    color: "#fff", 
    weight: tieneIca ? 2 : 1, // Borde más fino para los pequeños
    fillOpacity: tieneIca ? 0.95 : 0.6, // Más transparente si no tiene datos
    zIndexOffset: tieneIca ? 1000 : 0 
  });


      const resumenMeteo = `
        <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px; color: #2d3436; font-size: 0.9em;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span><i class="fas fa-thermometer-half" style="width: 15px;"></i> Temp:</span>
            <strong>${est.temp != "NaN" ? est.temp + " °C" : "--"}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span><i class="fas fa-tint" style="width: 15px;"></i> Hum:</span>
            <strong>${est.hum != "NaN" ? est.hum + " %" : "--"}</strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span><i class="fas fa-wind" style="width: 15px;"></i> Viento:</span>
            <strong>${est.viento != "NaN" ? est.viento + " km/h" : "--"}</strong>
          </div>
        </div>
      `;

const contenidoPopup = `
    <div style="text-align: center; font-family: 'Segoe UI', sans-serif; min-width: 160px;">
        <strong style="font-size: 1.1em; color: #2d3436;">${est.nombre}</strong><br>
        <div style="margin: 8px 0; padding: 6px; background: ${info.color}; color: white; border-radius: 4px; font-weight: bold; font-size: 0.9em;">
            ICA: ${est.calidad}
        </div>
        ${resumenMeteo}
       <button class="btn-detalle-mobile" 
                onclick="abrirDetalleDesdeMapa('${est.nombre.replace(/'/g, "\\'")}')" 
                style="background: #00acc1; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px;">
            <i class="fas fa-chart-bar"></i> Ver Detalles
        </button>
    </div>
`;
      
      marcador.bindPopup(contenidoPopup);
      marcadoresEstaciones[est.nombre] = marcador; 

      marcador.on('click', () => abrirDetalles(est));
      marcador.addTo(map);

      if (tieneIca) {
        if (!grupos[est.partido]) grupos[est.partido] = [];
        grupos[est.partido].push(est);
      }
    });

    // Crear la lista lateral por partidos
Object.keys(grupos).sort().forEach(partido => {
  const gDiv = document.createElement('div');
  gDiv.innerHTML = `<div class="partido-title">${partido}</div>`;

  // ORDENAR ALFABÉTICAMENTE LAS ESTACIONES DENTRO DEL PARTIDO
  grupos[partido].sort((a, b) => {
    return a.nombre.localeCompare(b.nombre);
  });

  grupos[partido].forEach(est => {
    const info = getICAInfo(est.calidad);
    const card = document.createElement('div');
    card.className = 'station-card'; 
    card.style.borderLeftColor = info.color;
    card.innerHTML = `
      <div><strong>${est.nombre}</strong></div>
      <div class="ica-badge" style="background:${info.color}22; color:${info.color}">ICA ${est.calidad}</div>
    `;
    
card.onclick = () => {
    const panel = document.getElementById('details-panel');
    
    if (window.innerWidth <= 768) {
        // MÓVIL
        panel.style.display = 'flex'; // Aseguramos que sea visible
        panel.classList.add('active-mobile');
        panel.classList.remove('active');
        abrirDetalles(est); 
    } else {
        // ESCRITORIO
        panel.style.display = 'block'; // Aseguramos que sea visible en PC
        panel.classList.add('active'); 
        panel.classList.remove('active-mobile'); 
        
        map.flyTo([est.lat, est.lng], 13);
        if (marcadoresEstaciones[est.nombre]) {
            marcadoresEstaciones[est.nombre].openPopup();
        }
        abrirDetalles(est);
    }
};
    gDiv.appendChild(card);
  });
  listDiv.appendChild(gDiv);
});
   const searchInput = document.getElementById('search-input');

searchInput.addEventListener('input', (e) => {
  const term = e.target.value.toLowerCase().trim();
  const bloquesPartidos = document.querySelectorAll('#station-list > div');

  // 1. Filtrar la Lista Lateral
  bloquesPartidos.forEach(bloque => {
    const tituloElemento = bloque.querySelector('.partido-title');
    if (tituloElemento) {
      const nombrePartido = tituloElemento.innerText.toLowerCase();
      const coincide = nombrePartido.includes(term);
      
      bloque.style.display = coincide ? 'block' : 'none';
    }
  });

  // 2. Filtrar los Marcadores en el Mapa
  // Recorremos todas las estaciones que cargaste originalmente
  estaciones.forEach(est => {
    const marcador = marcadoresEstaciones[est.nombre];
    if (marcador) {
      const nombrePartido = est.partido.toLowerCase();
      
      if (nombrePartido.includes(term)) {
        // Si el partido coincide o el buscador está vacío, asegurar que esté en el mapa
        if (!map.hasLayer(marcador)) {
          marcador.addTo(map);
        }
      } else {
        // Si no coincide, quitarlo del mapa
        map.removeLayer(marcador);
      }
    }
  });
});

    // --- ESTO QUITA EL CARTEL DE CARGANDO ---
    document.getElementById('main-loader').style.display = 'none';

  } catch (error) {
    console.error("Error al obtener estaciones:", error);
    // Opcional: mostrar un mensaje de error en el cargador si falla
    document.getElementById('main-loader').innerHTML = "<p>Error al cargar datos.</p>";
  }
}

// 3. Ejecutamos la función al cargar la ventana
window.onload = cargarEstacionesIniciales;

async function abrirDetalles(estacion) {
  // 1. RESET DE PESTAÑAS Y ESTADO VISUAL
  document.querySelectorAll('.tab-pane').forEach(pane => pane.style.display = 'none');
  document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
  
  // Activar pestaña de ICA por defecto
  document.getElementById('tab-ica').style.display = 'block';
  const primerIcono = document.querySelector('.menu-item'); 
  if (primerIcono) primerIcono.classList.add('active');

  // 2. LIMPIEZA Y ASIGNACIÓN DE NOMBRE
  let nombrePuro = estacion.nombre.replace(/Estación:|Estacion:/i, "").trim();
  document.getElementById('det-nombre').dataset.idEstacion = nombrePuro;
  document.getElementById('det-nombre').innerText = "Estación: " + nombrePuro;

  // 3. DETERMINAR SI ESTÁ ONLINE O OFFLINE
  const esOffline = (estacion.calidad === "Sin Datos" || isNaN(parseFloat(estacion.calidad)));
  const infoICA = getICAInfo(estacion.calidad); 

  // 4. CONFIGURAR PANEL DE DETALLES (GAUGE Y RECOMENDACIONES)
  document.getElementById('details-panel').classList.add('active');

 const rosaCont = document.getElementById('rosa-contenedor');
    if (rosaCont) {
        rosaCont.innerHTML = ''; // Borra el gráfico anterior
        rosaCont.style.display = 'none'; // Lo oculta hasta que carguen los nuevos datos
    }

 try {
      actualizarTabMeteo(estacion); 
  } catch (e) {
      console.error("Error al cargar la pestaña meteo:", e);
  }
  
  // MOVIMIENTO DEL BOTÓN: 460px (ancho panel) + 25px (margen original)
    document.getElementById('btn-ministerio').style.right = "485px";
    document.getElementById('btn-email').style.right = "485px";
    document.getElementById('btn-ayuda').style.right = "485px";
  
  setTimeout(() => {
    dibujarGauge(estacion.calidad, infoICA.color);
    actualizarRecomendaciones(estacion.calidad);
  }, 100);

  // 5. GESTIÓN DE CARGA DE DATOS HISTÓRICOS (24h)
  const loader = document.getElementById('charts-loader');
  const sectionHistorico = document.getElementById('historico-section');
  const areaCharts = document.getElementById('charts-area');

  loader.style.display = 'block';
  sectionHistorico.style.display = 'none';
  areaCharts.innerHTML = ''; 
  
  // 6. ACTUALIZAR PESTAÑA DE INFORMACIÓN (DATOS LOCALES)
  try {
    actualizarTabInfo(estacion);
  } catch (e) {
    console.error("Error al cargar Tab Info:", e);
  }

  // --- CAMBIO CLAVE: Sustitución de google.script.run por FETCH ---
  try {
    // Llamamos a tu URL de Google Script pasando la acción y el nombre de la estación
    const response = await fetch(`${urlScript}?action=obtenerHistorico&estacion=${encodeURIComponent(nombrePuro)}`);
    const datos = await response.json();

    loader.style.display = 'none';
    sectionHistorico.style.display = 'block';

    // VALIDACIÓN: Si el servidor no devuelve datos (Estación caída)
    if (!datos || !datos.labels || datos.labels.length === 0 || esOffline) {
      areaCharts.innerHTML = `
        <div style="text-align:center; padding:30px; background:#f8f9fa; border-radius:10px; border:1px dashed #ced4da; margin-top:20px;">
          <i class="fas fa-plug-circle-xmark" style="font-size:40px; color:#adb5bd; margin-bottom:15px; display:block;"></i>
          <strong style="color:#495057; display:block; margin-bottom:5px;">SIN CONEXIÓN EN TIEMPO REAL</strong>
          <p style="color:#6c757d; font-size:0.85em; margin:0;">
            La estación no está transmitiendo datos en este momento. 
            Las mediciones de las últimas 24 horas no están disponibles.
          </p>
        </div>`;
      return;
    }

    // Si hay datos, dibujar las barras normales
    dibujarBarras(datos);

  } catch (err) {
    // Este bloque reemplaza al withFailureHandler
    loader.style.display = 'none';
    areaCharts.innerHTML = '<p style="color:red; text-align:center; padding:20px;">Error de comunicación con el servidor.</p>';
    console.error("Error al cargar histórico:", err);
  }
}

function actualizarRecomendaciones(valorICA) {
  const info = getICAInfo(valorICA);
  const recCard = document.getElementById('rec-card');
  const catText = document.getElementById('rec-cat-text');
  const descText = document.getElementById('rec-desc-text');

 descText.style.fontSize = "1.0rem"; 
  catText.style.fontSize = "1.4rem";

  // Si el valor es "Sin Datos" o similar
  if (valorICA === "Sin Datos" || isNaN(parseFloat(valorICA))) {
    recCard.style.borderLeftColor = "#b2bec3"; // Color Gris
    catText.innerText = "ESTACIÓN FUERA DE LÍNEA";
    catText.style.color = "#636e72";
    descText.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i> 
      Esta estación no se encuentra conectada online actualmente. 
      Por este motivo, no es posible visualizar los datos en tiempo real. 
      <br><br>Consulte las pestañas de <b>Datos Mensuales</b> o <b>Anuales</b> para ver el registro histórico.`;
  } else {
    // Lógica normal para niveles de ICA
    recCard.style.borderLeftColor = info.color;
    catText.innerText = info.label;
    catText.style.color = info.color;
    descText.innerText = info.rec;
  }
}

function dibujarGauge(valor, colorActual) {
  if (gaugeChart) gaugeChart.destroy();
  const ctx = document.getElementById('gaugeChart').getContext('2d');
  
  let valorNumerico = parseFloat(valor) || 0;
  if (valorNumerico > 500) valorNumerico = 500;

  const gaugeNumElement = document.getElementById('gauge-number');
  
gaugeNumElement.style.whiteSpace = "nowrap";

  if (valor === "Sin Datos") {
    gaugeNumElement.innerHTML = `
      <span style="color: #636e72; font-size: 0.6em; font-weight: 800;">OFFLINE</span>
  `;} 
  
  else {
    gaugeNumElement.innerHTML = `
      <span style="color: #222; font-size: 0.55em; vertical-align: baseline; margin-right: 2px; font-weight: 800;">ICA:</span><span style="color: ${colorActual};">${valor || "0"}</span>
    `;
  }
  const dataFija = [50, 50, 50, 50, 100, 200]; 
  const coloresFijos = ["#2ecc71", "#f1c40f", "#e67e22", "#e74c3c", "#9b59b6", "#7e0023"];

  const gaugeNeedle = {
    id: 'gaugeNeedle',
    afterDraw(chart) {
      const { ctx, chartArea: { width }, animatable } = chart;
      
      // Capturamos el progreso de la animación del gráfico
      // Aunque el arco no se mueva, Chart.js genera un factor de 0 a 1
      const progress = chart.animating ? chart.currentStep / chart.numSteps : 1;

      ctx.save();
      const meta = chart.getDatasetMeta(0);
      const centerX = width / 2;
      const centerY = meta.data[0].y;
      const outerRadius = meta.data[0].outerRadius;
      
      // Calculamos el ángulo animado: 
      // Multiplicamos el valor final por el progreso (0 a 1)
      const valorAnimado = valorNumerico * progress;
      const angle = Math.PI + (Math.PI * (valorAnimado / 500));

      ctx.translate(centerX, centerY);
      ctx.rotate(angle);

      // --- DIBUJO DE LA AGUJA ---
      ctx.beginPath();
      ctx.moveTo(0, -6);
      ctx.lineTo(outerRadius - 6, 0);
      ctx.lineTo(0, 6); 
      ctx.fillStyle = '#111';
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(0, 0, 12, 0, Math.PI * 2); 
      ctx.fillStyle = '#111';
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(0, 0, 4, 0, Math.PI * 2);
      ctx.fillStyle = '#666';
      ctx.fill();
      
      ctx.restore();
    }
  };

  gaugeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: dataFija,
        backgroundColor: coloresFijos,
        borderWidth: 2,
        borderColor: '#000000',
        circumference: 180,
        rotation: 270,
      }]
    },
options: {
      cutout: '70%',
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2, // <--- CAMBIO CLAVE: Al ser medio círculo, el ancho debe ser el doble del alto
      layout: {
        padding: {
          top: 0,    // Elimina espacio superior
          bottom: 12  // Elimina espacio inferior
        }
      },
      animation: {
        duration: 2000,
        easing: 'easeOutQuart'
      },
      animations: {
        numbers: {
          properties: ['circumference', 'rotation'],
          duration: 0 
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    },
    plugins: [gaugeNeedle]
  });
}

 function dibujarBarras(datos) {
  const container = document.getElementById('charts-area');
  const updateElement = document.getElementById('update-time');
  
  barCharts.forEach(c => c.destroy()); 
  barCharts = [];
  
  // 1. INVERTIMOS LAS LABELS ORIGINALES
  // Hacemos una copia con [...] para no afectar el objeto original accidentalmente
  const labelsInvertidas = [...datos.labels].reverse();

  // 2. ACTUALIZAR EL TAG DE FECHA
  // Ahora el dato más reciente es el ÚLTIMO del array invertido
  if (labelsInvertidas.length > 0) {
    const ultimaFecha = new Date(labelsInvertidas[labelsInvertidas.length - 1]);
    const fechaTxt = ultimaFecha.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const horaTxt = ultimaFecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', hour12: false });
    updateElement.innerText = `${fechaTxt} ${horaTxt}`;
  }

  // 3. PREPARAR LABELS PARA EL EJE X (Solo horas 24h)
  const labelsHoras = labelsInvertidas.map(labelISO => {
    const d = new Date(labelISO);
    return d.toLocaleTimeString('es-AR', { 
      hour: '2-digit', 
      minute: '2-digit', 
      hour12: false 
    });
  });

  const orden = ["PM2.5", "PM10", "NO2", "SO2", "O3", "CO"];

  orden.forEach(cont => {
    let valoresOriginales = datos.datasets[cont];
    
    if (valoresOriginales && valoresOriginales.some(v => v > 0)) {
      // 4. INVERTIMOS LOS VALORES para que coincidan con el orden de las horas
      const valoresInvertidos = [...valoresOriginales].reverse();

      const box = document.createElement('div');
      box.className = 'chart-box';
      const canvasId = `chart-${cont.replace(/\./g, '')}`;
      box.innerHTML = `<h5 style="margin:0;">${cont} <small>(µg/m³)</small></h5><div class="chart-container"><canvas id="${canvasId}"></canvas></div>`;
      container.appendChild(box);

      const ctx = document.getElementById(canvasId).getContext('2d');
      const coloresBarras = valoresInvertidos.map(v => getColorByConcentracion(v, cont));

      const c = new Chart(ctx, {
        type: 'bar',
        data: { 
          labels: labelsHoras, 
          datasets: [{ 
            data: valoresInvertidos, 
            backgroundColor: coloresBarras, 
            borderRadius: 4 
          }] 
        },
        options: { 
  responsive: true, 
  maintainAspectRatio: false, 
  plugins: { 
    legend: { display: false },
    tooltip: {
       backgroundColor: 'rgba(0, 0, 0, 0.8)', // Fondo oscuro para mejor contraste
       titleFont: { size: 13 },
       bodyFont: { size: 12 },
       callbacks: {
         // Cambiamos el título del pop-up
         title: (context) => {
           const index = context[0].dataIndex;
           const fechaISO = labelsInvertidas[index]; // Obtenemos la fecha original
           const d = new Date(fechaISO);
           
           const fechaTxt = d.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: '2-digit' });
           const horaTxt = d.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', hour12: false });
           
           return `Fecha: ${fechaTxt} - Hora: ${horaTxt}`;
         },
         // Opcional: Personalizar el texto del valor
         label: (context) => {
           const valor = context.parsed.y.toFixed(2);
           return ` Concentración: ${valor} µg/m³`;
         }
       }
    }
  }, 
  scales: { 
    y: { beginAtZero: true },
    x: { 
      ticks: { 
        autoSkip: true, 
        maxTicksLimit: 6,
        font: { size: 10 }
      } 
    }
  } 
}
      });
      barCharts.push(c);
    }
  });
}

async function cargarPestanaMeteo(nombreEstacion) {
  const area = document.getElementById('meteo-charts-section');
  // Spinner de carga inicial
  area.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Cargando datos meteorológicos ultimas 24hs...</div>';

  try {
    const response = await fetch(`${urlScript}?action=obtenerMeteo&estacion=${encodeURIComponent(nombreEstacion)}`);
    const datos = await response.json();

    if (!datos || !datos.labels || datos.labels.length === 0) {
      area.innerHTML = '<p style="text-align:center; padding:20px;">No hay datos meteorológicos para esta estación.</p>';
      return;
    }

    // Definimos la estructura: Título -> Área de Gráficos -> Contenedor Rosa al final
    area.innerHTML = `
      <h3 style="text-align:center; margin-bottom:20px;">Meteorología: ${nombreEstacion} (24hs)</h3>
      <div id="meteo-area"></div>
    `;
    
    const meteoArea = document.getElementById('meteo-area');

    // Procesar etiquetas de tiempo
    const labelsISOInvertidas = [...datos.labels].reverse();
    const labelsH = labelsISOInvertidas.map(l => {
        const d = new Date(l);
        return d.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', hour12: false });
    });

    // Configuración de gráficos estándar (Sin dirección)
    const config = [
      { key: "Temperatura", label: "Temperatura (°C)", color: "#ff7675", type: "line" },
      { key: "Humedad", label: "Humedad (%)", color: "#74b9ff", type: "line" },
      { key: "Presion", label: "Presión (hPa)", color: "#55efc4", type: "line" },
      { key: "Velocidad", label: "Velocidad Viento (km/h)", color: "#a29bfe", type: "line" },
      { key: "Radiacion", label: "Radiación Solar (W/m²)", color: "#fdcb6e", type: "line" },
      { key: "Precipitacion", label: "Precipitación (mm)", color: "#0984e3", type: "bar" }
    ];

    if (window.meteoCharts) { window.meteoCharts.forEach(c => c.destroy()); }
    window.meteoCharts = [];

    // 1. Renderizar gráficos de Chart.js
    config.forEach(m => {
      let valoresOriginales = datos.datasets[m.key];
      if (valoresOriginales && valoresOriginales.some(v => v !== 0 && v !== null)) {
        const valoresInvertidos = [...valoresOriginales].reverse();
        const box = document.createElement('div');
        box.className = 'chart-box';
        const canvasId = `canv-${m.key}`;
        box.innerHTML = `<h5 style="margin:5px 0;">${m.label}</h5><div class="chart-container"><canvas id="${canvasId}"></canvas></div>`;
        meteoArea.appendChild(box);

        const ctx = document.getElementById(canvasId).getContext('2d');
        const chart = new Chart(ctx, {
            type: m.type,
            data: {
                labels: labelsH,
                datasets: [{
                    data: valoresInvertidos,
                    borderColor: m.color,
                    backgroundColor: m.type === 'line' ? m.color + '22' : m.color,
                    fill: m.type === 'line',
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        window.meteoCharts.push(chart);
      }
    });

    // 2. Finalmente, graficar la Rosa de los Vientos al fondo
    if (datos.datasets.Direccion && datos.datasets.Velocidad) {
        dibujarRosa(datos.datasets.Direccion, datos.datasets.Velocidad);
    }

  } catch (error) {
    console.error("Error cargando meteorología:", error);
    area.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Error al conectar con los datos meteorológicos.</p>';
  }
}

function dibujarRosa(direcciones, velocidades) {
    const contenedor = document.getElementById('rosa-contenedor');
    if (!contenedor) return;

    // 1. VALIDACIÓN INICIAL: ¿Hay datos no nulos?
    const hayDatosBrutos = direcciones && direcciones.length > 0 && direcciones.some((d, i) => {
        return d !== null && d !== "" && !isNaN(parseFloat(d)) && 
               velocidades[i] !== null && velocidades[i] !== "" && !isNaN(parseFloat(velocidades[i]));
    });

    if (!hayDatosBrutos) {
        contenedor.style.display = 'none';
        return;
    }

    const rumbos = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
    const rangos = [
        { label: '< 5 km/h', min: 0, max: 5, color: '#95e1d3' },
        { label: '5-15 km/h', min: 5, max: 15, color: '#eaffd0' },
        { label: '15-25 km/h', min: 15, max: 25, color: '#fce38a' },
        { label: '> 25 km/h', min: 25, max: 999, color: '#f38181' }
    ];

    let datosSeries = rangos.map(r => ({ name: r.label, data: new Array(16).fill(0), color: r.color }));
    
    // Contador para verificar si hay datos reales distintos a cero
    let totalRegistrosContados = 0;

    // Procesamos registros
    direcciones.forEach((deg, i) => {
        let d = parseFloat(deg);
        let v = parseFloat(velocidades[i]);
        
        if (isNaN(d) || isNaN(v)) return;
        
        let indiceRumbo = Math.round(d / 22.5) % 16;

        for (let j = 0; j < rangos.length; j++) {
            if (v >= rangos[j].min && v < rangos[j].max) {
                datosSeries[j].data[indiceRumbo]++;
                totalRegistrosContados++; // Incrementamos el contador global
                break;
            }
        }
    });

    // 2. SEGUNDA VALIDACIÓN: ¿La suma de registros es mayor a 0?
    if (totalRegistrosContados === 0) {
        contenedor.style.display = 'none';
        console.warn("Rosa de los vientos: Todos los datos son 0 o no entran en los rangos.");
        return;
    }

    // Si pasó ambas validaciones, mostramos y renderizamos
    contenedor.style.display = 'block';

    Highcharts.chart('rosa-contenedor', {
        chart: { polar: true, type: 'column' },
        title: { text: 'Distribución de Viento (Dirección y Velocidad)', style: { fontSize: '16px' } },
        subtitle: { text: 'Últimas 24 horas' },
        pane: { size: '85%' },
        xAxis: {
            categories: rumbos,
            tickmarkPlacement: 'on'
        },
        yAxis: {
            min: 0,
            endOnTick: false,
            showLastLabel: true,
            title: { text: 'Frecuencia (registros)' },
            labels: { enabled: true }
        },
        tooltip: {
            shared: true,
            pointFormat: '<span style="color:{series.color}">\u25CF</span> {series.name}: <b>{point.y}</b><br/>'
        },
        plotOptions: {
            column: {
                stacking: 'normal',
                shadow: false,
                groupPadding: 0,
                pointPlacement: 'on'
            }
        },
        series: datosSeries.reverse(), 
        credits: { enabled: false }
    });
}

function switchTab(event, tabId) {
  // Ocultar y desactivar todo
  document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
  
  // Activar lo seleccionado
  document.getElementById(tabId).style.display = 'block';
  if(event) event.currentTarget.classList.add('active');

  // Obtener nombre limpio de la estación para todas las pestañas
  let nombreHeader = document.getElementById('det-nombre').innerText;
  let nombreEstacion = nombreHeader.replace(/Estación:|Estacion:/i, "").trim();

  if (tabId === 'tab-meteo') {
    cargarPestanaMeteo(nombreEstacion);
  } 
  else if (tabId === 'tab-diario') {
    cargarPestanaPromedio(nombreEstacion);
  } 
  else if (tabId === 'tab-mensual') {
    cargarPestanaMensual(nombreEstacion);
  }
}
 

/**
 * Función principal que se dispara al seleccionar la pestaña o cambiar el periodo
 */
async function cargarPestanaPromedio(nombreEstacion) {
  const select = document.getElementById('select-periodo');
  const area = document.getElementById('promedio-charts-area');
  const loader = document.getElementById('promedio-loader');

  // Si no viene el nombre, lo rescatamos del encabezado del modal/panel
  if (!nombreEstacion) {
    nombreEstacion = document.getElementById('det-nombre').innerText.replace(/Estación:|Estacion:/i, "").trim();
  }

  // Si cambiamos de estación, reseteamos el selector de periodos
  if (select.dataset.estacionActual !== nombreEstacion) {
    select.innerHTML = ''; 
    select.dataset.estacionActual = nombreEstacion;
  }

  // 1. Carga inicial de Periodos (si el selector está vacío)
  if (select.options.length === 0) {
    area.innerHTML = '';
    loader.style.display = 'block';
    
    try {
      // REEMPLAZO: google.script.run -> fetch (obtenerPeriodos)
      const resP = await fetch(`${urlScript}?action=obtenerPeriodos&estacion=${encodeURIComponent(nombreEstacion)}`);
      const periodos = await resP.json();

      if (periodos && periodos.length > 0) {
        periodos.forEach(p => {
          let opt = document.createElement('option');
          opt.value = p; opt.innerHTML = p;
          select.appendChild(opt);
        });
        // Auto-llamada para cargar los datos del primer periodo encontrado
        cargarPestanaPromedio(nombreEstacion);
      } else {
        loader.style.display = 'none';
        area.innerHTML = '<p style="text-align:center; padding:30px;">No hay periodos registrados para esta estación.</p>';
      }
    } catch (err) {
      console.error("Error al obtener periodos:", err);
      loader.style.display = 'none';
    }
    return;
  }

  // 2. Carga de Datos y Renderizado de Gráficos
  const periodo = select.value;
  area.innerHTML = '';
  loader.style.display = 'block';

  try {
    // REEMPLAZO: google.script.run -> fetch (obtenerPromedioDiario)
    const resD = await fetch(`${urlScript}?action=obtenerPromedioDiario&estacion=${encodeURIComponent(nombreEstacion)}&periodo=${encodeURIComponent(periodo)}`);
    const datos = await resD.json();

    loader.style.display = 'none';
    
    // Limpiar gráficos anteriores para liberar memoria
    if (window.promedioCharts) {
        window.promedioCharts.forEach(c => c.destroy());
        window.promedioCharts = [];
    } else {
        window.promedioCharts = [];
    }

    if (!datos.labels || datos.labels.length === 0) {
      area.innerHTML = '<p style="text-align:center; padding:20px;">No hay datos para el periodo seleccionado.</p>';
      return;
    }

    // Configuración de contaminantes
    const configContaminantes = [
      { key: "PM10", label: "PM10", limit: 150, color: "#fab1a0" },
      { key: "PM2.5", label: "PM2.5", limit: 35, color: "#81ecec" },
      { key: "SO2", label: "SO2", limit: 125, color: "#a29bfe" },
      { key: "CO", label: "CO", limit: null, color: "#dfe6e9" },
      { key: "NO2", label: "NO2", limit: null, color: "#ffeaa7" },
      { key: "O3", label: "O3", limit: null, color: "#55efc4" }
    ];

    // Filtramos solo los que tienen valores > 0
    const activos = configContaminantes.filter(m => 
      datos.datasets[m.key] && datos.datasets[m.key].some(v => v > 0)
    );

    // Renderizado progresivo
    activos.forEach((m, index) => {
      setTimeout(() => {
        crearGraficoIndividual(m, datos, area);
      }, index * 50);
    });

  } catch (err) {
    console.error("Error al cargar promedios:", err);
    loader.style.display = 'none';
    area.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Error de comunicación con el servidor.</p>';
  }
}

function crearGraficoIndividual(m, datos, container) {
  const box = document.createElement('div');
  box.className = 'chart-box';
  const canvasId = `canv-prom-${m.key}`;
  
  const valores = datos.datasets[m.key];
  const valorMaximo = Math.max(...valores);
  
  // 1. Lógica de Excedencias
  let diasConExcedencia = [];
  if (m.limit) {
    valores.forEach((v, index) => {
      if (v > m.limit) diasConExcedencia.push(datos.labels[index]);
    });
  }
  const contadorExcedencias = diasConExcedencia.length;

  // 2. Construcción del HTML
  let htmlBadge = "";
  if (m.limit) {
    if (contadorExcedencias > 0) {
      htmlBadge = `<div class="status-badge status-danger"><i class="fas fa-exclamation-triangle"></i> <span>${contadorExcedencias} excedencias</span></div>`;
    } else {
      htmlBadge = `<div class="status-badge status-success"><i class="fas fa-check-circle"></i> <span>0 excedencias</span></div>`;
    }
  }

  box.innerHTML = `
    <div class="chart-header" style="display:flex; justify-content:space-between; align-items:center;">
      <h5 style="margin:0; font-size:14px;">${m.label}</h5>
      ${htmlBadge}
    </div>
    <div style="height:165px; position:relative; margin-top:10px;">
      <canvas id="${canvasId}"></canvas>
    </div>
    ${contadorExcedencias > 0 ? `<p style="font-size:10px; color:#d63031; margin:5px 0; font-weight:bold;">Días críticos: ${diasConExcedencia.join(", ")}</p>` : ''}
  `;
  container.appendChild(box);

  const ctx = document.getElementById(canvasId).getContext('2d');
  
  const nuevoGrafico = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: datos.labels,
      datasets: [{
        data: valores,
        backgroundColor: valores.map(v => (m.limit && v > m.limit) ? '#d63031' : m.color),
        borderRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => ` ${context.parsed.y.toFixed(2)} µg/m³`
          }
        }
      },
      scales: {
        y: { 
          beginAtZero: true, 
          suggestedMax: m.limit ? m.limit * 1.1 : undefined,
          title: {
            display: true,
            text: 'µg/m³', // UNIDADES EN EL EJE Y
            font: { size: 10, weight: 'bold' },
            color: '#636e72'
          },
          ticks: { 
            font: { size: 9 },
            callback: function(value) { return value; } // Puedes agregar ' µg/m³' aquí también si quieres
          }
        },
        x: { 
          ticks: { font: { size: 9 }, maxRotation: 0 } 
        }
      }
    },
    plugins: [{
      id: 'lineaLimite',
      afterDraw: (chart) => {
        if (m.limit) {
          const {ctx, scales: {y}, chartArea: {left, right}} = chart;
          const yPos = y.getPixelForValue(m.limit);
          if (yPos >= chart.chartArea.top && yPos <= chart.chartArea.bottom) {
            ctx.save();
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 1.5;
            ctx.strokeStyle = 'red';
            ctx.moveTo(left, yPos);
            ctx.lineTo(right, yPos);
            ctx.stroke();
            ctx.restore();
          }
        }
      }
    }]
  });
  promedioCharts.push(nuevoGrafico);
}
/**
 * Plugin para dibujar la línea roja de límite legal
 */
function pluginLineaLimite(limite) {
  return {
    id: 'lineaLimite',
    afterDraw: (chart) => {
      if (!limite) return;
      const {ctx, scales: {y}, chartArea: {left, right}} = chart;
      const yPos = y.getPixelForValue(limite);
      
      if (yPos >= chart.chartArea.top && yPos <= chart.chartArea.bottom) {
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = 'red';
        ctx.setLineDash([5, 5]);
        ctx.lineWidth = 1.5;
        ctx.moveTo(left, yPos);
        ctx.lineTo(right, yPos);
        ctx.stroke();
        ctx.restore();
      }
    }
  };
}

let datosMensualesGlobal = []; // Para filtrar sin volver al servidor

async function cargarPestanaMensual(nombreEstacion) {
  if (!nombreEstacion) {
    nombreEstacion = document.getElementById('det-nombre').dataset.idEstacion;
  }

  const containerBotones = document.getElementById('contaminantes-list');
  const selectorAño = document.getElementById('select-año-mensual');
  const loader = document.getElementById('mensual-loader');
  const filtros = document.getElementById('mensual-filtros');
  const contenido = document.getElementById('mensual-content');

  loader.style.display = 'block';
  filtros.style.display = 'none';
  contenido.style.display = 'none';
  
  containerBotones.innerHTML = "";
  selectorAño.innerHTML = "";

  try {
    const respuesta = await fetch(`${urlScript}?action=obtenerMensuales&estacion=${encodeURIComponent(nombreEstacion)}`);
    const res = await respuesta.json();

    loader.style.display = 'none';

    // Verificamos si hay datos en la tabla
    if (!res || !res.tabla || res.tabla.length === 0) {
      filtros.style.display = 'block';
      containerBotones.innerHTML = "<p style='text-align:center; padding:10px;'>No hay datos para esta estación.</p>";
      return;
    }

    // --- PROCESAMIENTO AUTOMÁTICO DE DATOS ---
    datosMensualesGlobal = res.tabla;

    // 1. Extraer años únicos y ordenar
    const listaAños = [...new Set(res.tabla.map(item => item.año))].sort((a, b) => b - a);
    
    // 2. Extraer contaminantes únicos
    const listaContam = [...new Set(res.tabla.map(item => item.contaminante))];

    // Llenar Selector de Años
    listaAños.forEach(a => {
      let opt = document.createElement('option');
      opt.value = a; opt.innerText = a;
      selectorAño.appendChild(opt);
    });

    // Crear Botones de Contaminantes
    listaContam.forEach((contam, index) => {
      let btn = document.createElement('button');
      btn.innerText = contam;
      btn.className = "btn-filtro-contam";
      if (index === 0) btn.classList.add('active');
      
      btn.onclick = function() {
        document.querySelectorAll('.btn-filtro-contam').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        actualizarVistaPorFiltros();
      };
      containerBotones.appendChild(btn);
    });

    filtros.style.display = 'block';
    contenido.style.display = 'block';
    actualizarVistaPorFiltros();

  } catch (error) {
    console.error("Error detallado:", error);
    loader.style.display = 'none';
    filtros.style.display = 'block';
    containerBotones.innerHTML = "<p style='color:red; text-align:center;'>Error al procesar los datos recibidos.</p>";
  }
}

function actualizarVistaPorFiltros() {
    const selector = document.getElementById('select-año-mensual');
    const btnActivo = document.querySelector('.btn-filtro-contam.active');
    
    if (!selector || !btnActivo || !datosMensualesGlobal) return;

    const añoSeleccionado = String(selector.value);
    const contamSeleccionado = btnActivo.innerText.trim();

    console.log("Filtrando datos para:", añoSeleccionado, contamSeleccionado);

    // Filtramos asegurando que ambos sean tratados como String
    const filtrados = datosMensualesGlobal.filter(d => 
        String(d.año) === añoSeleccionado && 
        String(d.contaminante).toUpperCase() === contamSeleccionado.toUpperCase()
    );

    renderizarVistaMensual(contamSeleccionado, filtrados);
}
    
function renderizarVistaMensual(contam, datosFiltrados) {
  const areaTabla = document.getElementById('tabla-mensual-area');
  const canvas = document.getElementById('canvas-mensual');
  
  // Validamos que el canvas exista
  if (!canvas) {
    console.error("No se encontró el elemento canvas-mensual");
    return;
  }

  // 1. DIBUJAR GRÁFICO
  const ctx = canvas.getContext('2d');
  if (window.chartMensualInstance) window.chartMensualInstance.destroy();

  // Ordenar datos por fecha si fuera necesario (opcional)
  // datosFiltrados.sort((a, b) => new Date(a.periodo) - new Date(b.periodo));

  window.chartMensualInstance = new Chart(ctx, {
    type: 'bar', 
    data: {
      labels: datosFiltrados.map(d => {
        // Formatear etiqueta: "enero 2016" -> "Enero"
        const parte = d.periodo.split(' ')[0];
        return parte.charAt(0).toUpperCase() + parte.slice(1);
      }),
      datasets: [{
        label: `Promedio Mensual ${contam}`,
        data: datosFiltrados.map(d => d.promedio),
        borderColor: '#0984e3',
        backgroundColor: 'rgba(9, 132, 227, 0.7)',
        borderWidth: 1,
        borderRadius: 5
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Concentración' }
        },
        x: {
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: true, position: 'top' },
        tooltip: { enabled: true }
      }
    }
  });

  // 2. CREAR TABLA
  if (datosFiltrados.length === 0) {
    areaTabla.innerHTML = "<p style='text-align:center;'>No hay registros para este filtro.</p>";
    return;
  }

  areaTabla.innerHTML = `
    <table class="report-table" style="width:100%; border-collapse: collapse; margin-top: 20px;">
      <thead>
        <tr style="background-color: #f8f9fa;">
          <th style="padding: 10px; border: 1px solid #eee;">Periodo</th>
          <th style="padding: 10px; border: 1px solid #eee;">Promedio</th>
          <th style="padding: 10px; border: 1px solid #eee;">Máximo</th>
          <th style="padding: 10px; border: 1px solid #eee;">Excedencias</th>
        </tr>
      </thead>
      <tbody>
        ${datosFiltrados.map(d => {
          const prom = Number(d.promedio);
          const max = Number(d.maximo);
          const exc = Number(d.excedencias);
          
          return `
            <tr>
              <td style="padding: 8px; border: 1px solid #eee; text-align: center;">${d.periodo}</td>
              <td style="padding: 8px; border: 1px solid #eee; text-align: center;">${!isNaN(prom) ? prom.toFixed(2) : d.promedio}</td>
              <td style="padding: 8px; border: 1px solid #eee; text-align: center;">${!isNaN(max) ? max.toFixed(2) : d.maximo}</td>
              <td style="padding: 8px; border: 1px solid #eee; text-align: center; font-weight: bold; color:${exc > 0 ? '#d63031' : '#27ae60'};">
                ${exc}
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>`;
}
function cerrarPanel() {
    const panel = document.getElementById('details-panel');
    
    // 1. Quitamos las clases de activación (tanto para PC como para móvil)
    panel.classList.remove('active');
    panel.classList.remove('active-mobile');
    if (window.innerWidth < 768) panel.style.display = 'none';
    

    // 2. Solo movemos los botones si NO es móvil
    // Si el ancho de pantalla es mayor a 768px, ejecutamos el movimiento
    if (window.innerWidth > 768) {
        document.getElementById('btn-ministerio').style.right = "25px";
        document.getElementById('btn-email').style.right = "25px";
        document.getElementById('btn-ayuda').style.right = "25px";
    }
}

const PREGUNTAS_LOCALES = [
 {
  pregunta: "¿Qué es el CEMCA?",
  respuesta: `<p style="margin: 0; font-size: 1.05em;">El <strong>Centro de Monitoreo de Calidad de Aire (CEMCA)</strong> se constituye dentro de la <strong>Dirección de Evaluación Ambiental en Calidad de Aire y Gestión de Emisiones</strong> del Ministerio de Ambiente de la Provincia de Buenos Aires. Su objetivo estratégico es la centralización, procesamiento y fiscalización de datos provenientes de la <strong>red de estaciones de monitoreo continuo</strong>, integrando aportes tanto del sector público como privado. A través de una infraestructura tecnológica de precisión, el CEMCA supervisa de manera ininterrumpida las concentraciones de contaminantes atmosféricos (<strong>PM<sub>10</sub>, PM<sub>2.5</sub>, SO<sub>2</sub>, NO<sub>2</sub>, CO y O<sub>3</sub></strong>). En cumplimiento con el marco normativo vigente (<strong>Decreto 1074/18</strong>), estos datos técnicos son convertidos en el <strong>Índice de Calidad de Aire (ICA)</strong>. Este proceso de traducción técnica permite al Estado Provincial garantizar el <strong>derecho a la información ambiental</strong>, brindando a la ciudadanía una herramienta <strong>oficial, simplificada y en tiempo real</strong> para el conocimiento del estado del recurso aire en todo el territorio bonaerense.
  </p>`
},
  {
    pregunta: "¿Cuál es su Marco Regulatorio?",
    respuesta: `<p>El <strong>CEMCA</strong> opera bajo el marco del <a href='https://normas.gba.gob.ar/documentos/0zWjvSXx.pdf' target='_blank' style='color: #00b1c9; font-weight: bold; text-decoration: underline;'>Decreto 1074/18</a>, el cual crea el Registro Provincial de Monitoreo (RPM-GECA).</p>
                <p>Este marco legal establece que el Centro debe:</p>
                <ul style="padding-left: 20px; margin-bottom: 15px;">
                  <li><strong>Centralizar los datos</strong> de Monitoreo Continuo de toda la provincia.</li>
                  <li><strong>Identificar y correlacionar</strong> el origen de la contaminación.</li>
                  <li><strong>Integrar inventarios de emisiones</strong> para detectar "áreas críticas".</li>
                </ul>
                <p style="border-top: 1px solid #eee; padding-top: 10px;"><em>Es la herramienta jurídica que permite al <strong>Ministerio de Ambiente</strong> fiscalizar las emisiones gaseosas.</em></p>`
  },
  {
    pregunta: "¿Qué es un Índice de Calidad de Aire?",
    respuesta: "Un índice de Calidad de aire es un valor informado por las agencias gubernamentales para comunicar a la población el nivel de contaminación en el aire de forma instantánea. Esta información es de suma importancia, debido a que a niveles altos del ICA se puede ver afectada la salud. En la actualidad, ante la falta de un índice nacional, se ha optado por utilizar la metodología de la USEPA (Agencia de Protección Ambiental de EE.UU.)."
  },
  {
  pregunta: "¿Qué Informa un Índice de Calidad de Aire?",
  respuesta: `<p>El <strong>ICA</strong> es un valor numérico que comunica de forma sencilla qué tan limpio o contaminado está el aire y qué efectos podría tener en la salud. Se divide en 6 categorías según el nivel de riesgo:</p><div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:14px;text-align:left;margin:10px 0;"><thead><tr style="background-color:#f2f2f2;"><th style="padding:8px;border:1px solid #ddd;">Rango ICA</th><th style="padding:8px;border:1px solid #ddd;">Categoría</th><th style="padding:8px;border:1px solid #ddd;">Color</th></tr></thead><tbody><tr><td style="padding:8px;border:1px solid #ddd;">0 - 50</td><td style="padding:8px;border:1px solid #ddd;font-weight:bold;color:#008000;">Bueno</td><td style="padding:8px;border:1px solid #ddd;background-color:#00e400;"></td></tr><tr><td style="padding:8px;border:1px solid #ddd;">51 - 100</td><td style="padding:8px;border:1px solid #ddd;font-weight:bold;color:#b8860b;">Moderado</td><td style="padding:8px;border:1px solid #ddd;background-color:#ffff00;"></td></tr><tr><td style="padding:8px;border:1px solid #ddd;">101 - 150</td><td style="padding:8px;border:1px solid #ddd;font-weight:bold;color:#ff8c00;">Dañina para grupos sensibles</td><td style="padding:8px;border:1px solid #ddd;background-color:#ff7e00;"></td></tr><tr><td style="padding:8px;border:1px solid #ddd;">151 - 200</td><td style="padding:8px;border:1px solid #ddd;font-weight:bold;color:#ff0000;">Dañina a la salud</td><td style="padding:8px;border:1px solid #ddd;background-color:#ff0000;"></td></tr><tr><td style="padding:8px;border:1px solid #ddd;">201 - 300</td><td style="padding:8px;border:1px solid #ddd;font-weight:bold;color:#800080;">Muy dañina a la salud</td><td style="padding:8px;border:1px solid #ddd;background-color:#8f3f97;"></td></tr><tr><td style="padding:8px;border:1px solid #ddd;">301+</td><td style="padding:8px;border:1px solid #ddd;font-weight:bold;color:#800000;">Peligroso</td><td style="padding:8px;border:1px solid #ddd;background-color:#7e0023;"></td></tr></tbody></table></div><p><em>Cuanto mayor es el valor del ICA, mayor es el nivel de contaminación y el riesgo para la salud de la población.</em></p>`
}, 
{
  pregunta: "¿Cómo se calcula el Índice de Calidad de Aire?",
  respuesta: `<p>El cálculo del <strong>ICA</strong> se realiza mediante una fórmula matemática que convierte mediciones técnicas en una escala de 0 a 500. Es similar a pasar una calificación a una escala porcentual para que sea fácil de entender.</p><p>El proceso sigue estos puntos:</p><ul style="padding-left:20px;"><li><strong>Medición:</strong> Los sensores captan la concentración de contaminantes en el aire.</li><li><strong>Comparación:</strong> Se coteja el dato con los límites legales del Decreto 1074/18.</li><li><strong>Conversión:</strong> Se calcula en qué nivel de la escala cae dicha medición.</li></ul><div style="background-color:#f9f9f9;padding:10px;border-radius:5px;border-left:4px solid #00b1c9;margin:10px 0;"><strong>Dato clave:</strong> El valor de <strong>ICA 100</strong> es el límite máximo permitido por la normativa. Superar este valor indica que el aire empieza a ser poco saludable.</div><p>Si se miden varios contaminantes, el ICA final corresponde al <strong>valor más alto detectado</strong>, ya que representa el mayor riesgo para la salud en ese momento.</p>`
}
  // Agrega las demás aquí siguiendo el mismo formato...
];

function abrirModalPreguntas() {
  const modal = document.getElementById('modal-faq');
  const lista = document.getElementById('faq-lista');

  modal.style.display = 'block';

  let html = "";
  PREGUNTAS_LOCALES.forEach((p) => {
    html += `
      <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          ${p.pregunta}
        </button>
        <div class="accordion-panel">
          <p>${p.respuesta}</p>
        </div>
      </div>`;
  });

  lista.innerHTML = html;
}

function toggleAccordion(elemento) {
  // Toggle de la clase "active" para la flecha
  elemento.classList.toggle("active");

  const panel = elemento.nextElementSibling;
  
  if (panel.style.maxHeight) {
    // Si está abierto, lo cerramos
    panel.style.maxHeight = null;
  } else {
    // Si está cerrado, calculamos la altura real + un pequeño margen de seguridad
    // Usamos scrollHeight que mide el contenido total aunque no sea visible
    panel.style.maxHeight = panel.scrollHeight + "px";
  }
}

function cerrarModalPreguntas() {
  document.getElementById('modal-faq').style.display = 'none';
}

const INFO_INSTITUCIONAL = {
agradecimientosEspeciales: {
    "UNGS": { 
        lugar: "la Universidad Nacional de General Sarmiento (UNGS)", 
        agradecimiento: "a la Universidad Nacional de General Sarmiento",
        url: "https://www.ungs.edu.ar/" 
    },
    "Moreno": { 
        lugar: "la Universidad Nacional de Moreno", 
        agradecimiento: "a la Universidad Nacional de Moreno",
        url: "http://www.unm.edu.ar/" 
    },
    "Tigre": { 
        lugar: "la UTN sede Pacheco", 
        agradecimiento: "a la Universidad Tecnológica Nacional (Sede Pacheco)",
        url: "https://www.frgp.utn.edu.ar/" 
    },
    "Rodriguez": { 
        lugar: "la Secretaría de Producción y Desarrollo del Municipio de General Rodriguez", 
        agradecimiento: "a la Secretaría de Producción y Desarrollo",
        url: "https://www.generalrodriguez.gob.ar/" 
    }
  },
administradores: {
    "YPF S.A.": { 
      desc: "Empresa de energía que opera la red de monitoreo en el Gran La Plata.", 
      url: "https://www.ypf.com/",
      logo: "https://i.pinimg.com/736x/ed/90/83/ed908349a40c0d489f89e34edcb34c21.jpg"
    },
    "Acumar": { 
      desc: "La Autoridad de Cuenca Matanza Riachuelo (ACUMAR) es un ente autónomo e interjurisdiccional.", 
      url: "https://www.acumar.gob.ar/",
      logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTa_jsO1Y4dGXPlZQsnMk1ehrW1MRx2rX7Kkg&s"
    },
    "Cicacz": { 
      desc: "Comité Interindustrial de Conservación del Ambiente Campana-Zárate, conformado por 22 empresas del sector.", 
      url: "https://www.cicacz.com.ar/",
      logo: "https://eldebate.com.ar/wp-content/uploads/2021/06/cicacz_logo-1-300x201.jpg"
    },
    "Ministerio de Ambiente de la Provincia de Buenos Aires": { 
      desc: "Organismo responsable de la política ambiental provincial, encargado de fiscalizar y preservar el ambiente de la Provincia de Buenos Aires.", 
      url: "https://www.ambiente.gba.gob.ar/",
      logo: "https://logosandtypes.com/wp-content/uploads/2020/10/buenos-aires-provincia.svg" // Nota: Si el fondo es claro, podrías necesitar la versión color
    },
    "CTE (Municipalidad de Bahía Blanca)": { 
      desc: "Comité Técnico Ejecutivo encargado del control y monitoreo de las industrias del Polo Petroquímico.", 
      url: "https://www.bahia.gob.ar/cte/",
      logo: "https://www.bahia.gob.ar/wp-content/uploads/2016/11/bahia-medioambiente.png"
    },
    "Oxbow S.A.": { 
      desc: "Empresa que opera estaciones de monitoreo continuo en el sector de Berisso y Ensenada.", 
      url: "https://www.oxbow.com/",
      logo: "https://prensabonaerense.com.ar/adjuntos/imagenes-notas/7761.jpg"
    },
    "Sika S.A.": { 
      desc: "Empresa fabricante de materiales de construcción con estaciones de monitoreo de material particulado.", 
      url: "https://klaukol.com.ar/",
      logo: "https://s3-symbol-logo.tradingview.com/sika--600.png"
    },
    "AQI": { 
      desc: "Plataforma global que recopila y presenta datos del Índice de Calidad del Aire (AQI).", 
      url: "https://aqicn.org/map/world/",
      logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ5A3VNrnbd_ONoNT7VXct6-vU2bcuXYo760g&s"
    },
    "PurpleAir": { 
      desc: "Red distribuida de sensores de bajo costo que proporcionan datos de calidad del aire.", 
      url: "https://www2.purpleair.com/",
      logo: "https://brands.home-assistant.io/_/purpleair//logo.png"
    }
  }
};

function actualizarTabInfo(estacion) {
  const tabInfo = document.getElementById('tab-info');
  if (!tabInfo) return;

  const nombrePuro = estacion.nombre.replace(/Estación:|Estacion:/i, "").trim();
  const adminNombre = estacion.Administrador;
  const adminInfo = INFO_INSTITUCIONAL.administradores[adminNombre] || { desc: "Info en actualización.", url: "#", logo: "" };
  const agradecimiento = INFO_INSTITUCIONAL.agradecimientosEspeciales[nombrePuro];

  let html = `
    <div style="padding: 5px 15px 15px 15px; font-family: 'Segoe UI', sans-serif; color: #2d3436;">
      
      <div style="margin-bottom: 15px;">
        <h4 style="color: #00aec3; border-bottom: 2px solid #00aec3; padding-bottom: 5px; margin: 0 0 12px 0; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px;">Gestión y Mantenimiento</h4>
        
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
          ${adminInfo.logo ? `<img src="${adminInfo.logo}" style="max-width: 80px; max-height: 50px; object-fit: contain;">` : ''}
          <strong style="color: #2d3436; font-size: 1.1em; line-height: 1.2;">${adminNombre}</strong>
        </div>

        <p style="font-size: 0.95em; color: #636e72; line-height: 1.6; margin-bottom: 15px;">${adminInfo.desc}</p>
        
        ${adminInfo.url !== "#" ? `
          <a href="${adminInfo.url}" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; color: white; background: #00aec3; text-decoration: none; font-weight: bold; font-size: 0.85em; padding: 8px 16px; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,174,0.1);">
            <i class="fas fa-external-link-alt"></i> Sitio Web Oficial
          </a>
        ` : ''}
      </div>

      <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

      <div style="margin-bottom: 25px;">
        <h4 style="color: #636e72; font-size: 0.85em; text-transform: uppercase; margin-bottom: 12px;">Especificaciones Técnicas</h4>
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #edf2f7; display: flex; flex-direction: column; gap: 8px;">
          <div>
            <small style="color: #00aec3; font-weight: 800; font-size: 0.65em; text-transform: uppercase; display: block;">Contaminantes</small>
            <span style="font-size: 0.9em; font-weight: 500;">${estacion.Contaminantes}</span>
          </div>
          <div>
            <small style="color: #00aec3; font-weight: 800; font-size: 0.65em; text-transform: uppercase; display: block;">Ubicación</small>
            <span style="font-size: 0.9em;">Lat: ${parseFloat(estacion.lat).toFixed(2)} | Long: ${parseFloat(estacion.lng).toFixed(2)}</span>
          </div>
        </div>
      </div>

     ${agradecimiento ? `
        <div style="background: #f0f9ff; border: 1px solid #bae1ff; padding: 15px; border-radius: 10px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <i class="fas fa-university" style="color: #1565c0; font-size: 1.2em;"></i>
            <h4 style="margin: 0; color: #1565c0; font-size: 0.85em; text-transform: uppercase; font-weight: 700;">Convenio Institucional</h4>
          </div>
          <p style="margin: 0; font-size: 0.85em; color: #2c5282; line-height: 1.5;">
            Esta estación fue adquirida en el marco de un trabajo conjunto con el <strong>COMIREC</strong> y se encuentra emplazada en 
            <a href="${agradecimiento.url}" target="_blank" style="color: #1565c0; font-weight: bold; text-decoration: underline;">${agradecimiento.lugar}</a>.
            Agradecemos a dicha institución por el compromiso compartido con el monitoreo ambiental.
          </p>
        </div>
      ` : ''}
    </div>
  `;

  tabInfo.innerHTML = html;
}

function abrirContacto() {
            document.getElementById('modal-contacto').style.display = 'flex';
        }

        function cerrarContacto() {
            document.getElementById('modal-contacto').style.display = 'none';
        }

      document.getElementById('form-cemca').addEventListener('submit', function(e) {
    e.preventDefault(); // Detiene el envío normal

    // 1. Capturamos los datos que escribió el usuario
    const nombre = this.querySelector('input[type="text"]').value;
    const emailUsuario = this.querySelector('input[type="email"]').value;
    const asunto = document.getElementById('asunto-mail').value;
    const mensaje = this.querySelector('textarea').value;

    // 2. Construimos el enlace de envío
    const mailtoLink = `mailto:cemca@ambiente.gba.gob.ar`
        + `?subject=${encodeURIComponent(asunto)}`
        + `&body=${encodeURIComponent("Nombre: " + nombre + "\nEmail: " + emailUsuario + "\n\nConsulta:\n" + mensaje)}`;

    // 3. Abrimos el gestor de correo del usuario con los datos cargados
    window.location.href = mailtoLink;

    // 4. Cerramos el modal y mostramos tu cartel de éxito
    cerrarContacto();
    const notificacion = document.getElementById('notificacion-exito');
    notificacion.classList.add('mostrar');
    setTimeout(() => {
        notificacion.classList.remove('mostrar');
    }, 4000);

    this.reset();
});

        // Cerrar al hacer clic afuera
        window.onclick = function(event) {
            let modal = document.getElementById('modal-contacto');
            if (event.target == modal) {
                cerrarContacto();
            }
        }

   function mostrarEnMapa(est) {
    if (window.innerWidth <= 768) {
        // 1. Ocultamos la sidebar en móvil
        document.querySelector('.sidebar').classList.add('hidden-mobile');
        document.body.classList.add('view-map');
    }

    // 2. Lógica normal de Leaflet
    map.flyTo([est.lat, est.lng], 15);
    if (marcadoresEstaciones[est.nombre]) {
        marcadoresEstaciones[est.nombre].openPopup();
    }
    abrirDetalles(est); // Tu función que abre el panel de detalles
}

// Función para volver a la lista de partidos
function toggleVistaMapa() {
    const sidebar = document.getElementById('sidebar'); // Cambiado de querySelector a getElementById
    const btnVolver = document.getElementById('btn-volver-lista-flotante');

    if (sidebar) {
        sidebar.classList.add('hidden-mobile');
        
        // Mostrar el botón de volver si no existe
        if (!btnVolver) {
            const nuevoBtn = document.createElement('button');
            nuevoBtn.id = 'btn-volver-lista-flotante';
            nuevoBtn.innerHTML = '<i class="fas fa-list"></i> Volver a Lista de Partidos';
            

            nuevoBtn.onclick = function() {
                sidebar.classList.remove('hidden-mobile');
                nuevoBtn.remove();
            };
            document.body.appendChild(nuevoBtn);
        }

        // Refrescar el mapa para que ocupe todo el espacio
        setTimeout(() => {
            map.invalidateSize();
        }, 300);
    }
}
   
// 3. LA FUNCIÓN QUE USA EL BOTÓN DEL MAPA
function abrirDetalleDesdeMapa(nombreRecibido) {
    // Buscamos en la variable global que ahora sí existe
    const est = window.estacionesGlobal.find(e => e.nombre === nombreRecibido);
    
    if (est) {
        const panel = document.getElementById('details-panel');
        
        if (window.innerWidth <= 768) {
            panel.classList.add('active-mobile');
            panel.classList.remove('active');
        } else {
            panel.classList.add('active');
            panel.classList.remove('active-mobile');
        }
        
        // Llamamos a tu función original para cargar los gráficos
        abrirDetalles(est);
    } else {
        console.error("No se encontró la estación:", nombreRecibido);
    }
}
   
function actualizarTabMeteo(estacion) {
    const contenedor = document.getElementById('meteo-cards-container');
    if (!contenedor) return;

    // 1. Limpiamos el contenedor antes de empezar
    contenedor.innerHTML = '';

    // 2. Encabezado con Fecha/Hora
    let html = `
        <div style="background: #e0f7f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #00aec3; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-clock" style="color: #00aec3;"></i> 
            <span style="font-size: 0.85em; color: #2d3436;">
                Reporte: <strong>${estacion.fechaMeteo || '--'}</strong>
            </span>
        </div>
        <div class="meteo-grid">
    `;

    // 3. Lista de sensores (Usando los nombres de propiedades que definimos en el Apps Script)
    const sensores = [
        { id: 'temp', label: 'Temperatura', valor: estacion.temp, unidad: '°C', icono: 'fas fa-thermometer-half' },
        { id: 'hum', label: 'Humedad', valor: estacion.hum, unidad: '%', icono: 'fas fa-tint' },
        { id: 'pres', label: 'Pres. Atm', valor: estacion.pres, unidad: ' hPa', icono: 'fas fa-tachometer-alt' },
        { id: 'viento', label: 'Viento', valor: estacion.viento, unidad: ' km/h', icono: 'fas fa-wind' },
        { id: 'dir', label: 'Dirección', valor: estacion.viento_dir, unidad: '°', icono: 'fas fa-long-arrow-alt-up' },
        { id: 'rad', label: 'Rad. Solar', valor: estacion.radiacion, unidad: ' W/m²', icono: 'fas fa-sun' },

    ];

    // 4. Bucle para generar tarjetas solo si el dato es válido
    sensores.forEach(s => {
        const valNum = parseFloat(s.valor);
        
        // Verificamos si es un número válido
        if (!isNaN(valNum)) {
      if (s.id === 'dir') {
    const direccionTexto = obtenerDireccionTexto(valNum);
    html += `
        <div class="meteo-card">
            <i class="${s.icono} wind-arrow" style="transform: rotate(${valNum}deg);"></i>
            <span>${s.label}</span>
            <strong style="font-size: 0.95rem;">${direccionTexto}</strong>
            <small style="font-size: 0.75em; color: #95a5a6;">${valNum}°</small>
        </div>`;
          } else {
                // Tarjeta estándar
                html += `
                    <div class="meteo-card">
                        <i class="${s.icono}"></i>
                        <span>${s.label}</span>
                        <strong>${valNum}${s.unidad}</strong>
                    </div>`;
            }
        }
    });

    html += '</div>'; // Cerramos el grid
    
    // Inyectamos todo el HTML generado en el contenedor
    contenedor.innerHTML = html;
}

   function obtenerDireccionTexto(grados) {
    const val = parseFloat(grados);
    if (isNaN(val)) return "--";
    
    // Arreglo de direcciones cada 22.5 grados
    const direcciones = [
        "Norte", "Norte-Noreste", "Noreste", "Este-Noreste", 
        "Este", "Este-Sureste", "Sureste", "Sur-Sureste", 
        "Sur", "Sur-Sudoeste", "Sudoeste", "Oeste-Sudoeste", 
        "Oeste", "Oeste-Noroeste", "Noroeste", "Norte-Noroeste"
    ];
    
    // Calculamos el índice (sumamos 11.25 para centrar el rango)
    const indice = Math.floor(((val + 11.25) % 360) / 22.5);
    return direcciones[indice];
}
  </script>
</body>
</html>




















































